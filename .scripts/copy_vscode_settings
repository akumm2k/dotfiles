#!/usr/bin/env bash
set -euo pipefail


# Load environment variables from .env in the same directory as the script
SCRIPT_DIR="$(realpath "$(dirname "${BASH_SOURCE[0]}")")"
ENV_FILE="$SCRIPT_DIR/.env"

if [[ -f "$ENV_FILE" ]]; then
    # shellcheck disable=SC1090
    source "$ENV_FILE"
else
    echo "Error: .env file not found at $ENV_FILE"
    exit 1
fi

# Ensure required env vars are set
if [[ -z "$PRIVATE_START" || -z "$PRIVATE_END" ]]; then
    echo "Error: PRIVATE_START or PRIVATE_END is not set in $ENV_FILE"
    exit 1
fi


# Default paths
DEFAULT_FROM="$HOME/Library/Application Support/Code/User/settings.json"
DEFAULT_TO="/Users/aryan/.vscode/settings.json"

# Parse arguments
FROM="$DEFAULT_FROM"
TO="$DEFAULT_TO"

while [[ $# -gt 0 ]]; do
    case $1 in
        -f|--from)
            FROM="$2"
            shift 2
            ;;
        -t|--to)
            TO="$2"
            shift 2
            ;;
        *)
            echo "Unknown option: $1"
            exit 1
            ;;
    esac
done

# Check if source file exists
if [[ ! -f "$FROM" ]]; then
    echo "Source file does not exist: $FROM"
    exit 1
fi

# Copy the file
cp "$FROM" "$TO"

# Remove the private section
sed -i.bak "\|$PRIVATE_START|,\|$PRIVATE_END|d" "$TO"

# Check if sed succeeded
if [[ $? -eq 0 ]]; then
    # sed succeeded -> remove backup
    rm -f "$TO.bak"
else
    echo "sed failed! Backup retained at $TO.bak"
fi

echo "Copied $FROM to $TO and removed private section."